
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#0d1b2a">
  <title>Flappy Clone</title>
  <link rel="manifest" href="flappy_manifest.json">
  <style>
    html,body{margin:0;height:100%;background:#0d1b2a;color:#fff;font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial}
    .wrap{display:flex;align-items:center;justify-content:center;height:100%}
    canvas{background:linear-gradient(#5cc8ff,#6ee1ff 60%,#b8f3ff);border-radius:12px;touch-action:none}
    #jump{position:fixed;right:16px;bottom:28px;width:84px;height:84px;border-radius:50%;border:0;font-weight:800}
  </style>
</head>
<body>
  <div class="wrap"><canvas id="game" width="420" height="680"></canvas></div>
  <button id="jump">SAUT</button>
  <script>
  (()=>{
    const cvs=document.getElementById('game'), c=cvs.getContext('2d');
    const BASE_W=cvs.width, BASE_H=cvs.height;

    // Parallaxe: nuages
    const clouds = Array.from({length:6},()=>({x: Math.random()*BASE_W, y: 40+Math.random()*220, s: 0.2+Math.random()*0.6}));

    // Oiseau + état
    const bird={x:90,y:BASE_H*0.42,r:14,vy:0,rot:0};
    let targetRot=0, pipes=[], lastSpawn=0, running=false, waitingStart=true, gameOver=false, score=0, best=0;
    try{best=parseInt(localStorage.getItem('flappy_best')||'0',10);}catch{}

    // Physique & difficulté
    const G=0.45, JUMP=-7.8, PIPE_W=68, SPAWN_MS=1400;
    const BASE_SPEED=2.8, BASE_GAP_MIN=150, BASE_GAP_MAX=190;
    function difficulty(){
      const t=Math.min(1, score/25); // progression lissée jusqu’à 25 pts
      return {
        speed: BASE_SPEED + t*1.0,           // +1px/frame max
        gapMin: BASE_GAP_MIN - t*40,         // -40px d’écart
        gapMax: BASE_GAP_MAX - t*40
      };
    }

    function rand(a,b){ return Math.random()*(b-a)+a; }

    function spawnPipe(){
      const d=difficulty();
      const gap=rand(d.gapMin,d.gapMax);
      const topH=rand(50, BASE_H-200);
      pipes.push({x:BASE_W+20, top:topH, gap:gap, w:PIPE_W, passed:false});
    }

    function startGame(){ if(!waitingStart) return; waitingStart=false; running=true; flap(); }
    function flap(){
      if(gameOver){ hardReset(); return; }
      bird.vy = Math.max(JUMP, bird.vy - 3); // flap progressif
    }

    function hardReset(){
      pipes=[]; bird.y=BASE_H*0.42; bird.vy=0; bird.rot=0;
      score=0; lastSpawn=0; running=false; waitingStart=true; gameOver=false;
      spawnPipe();
    }

    // Contrôles
    const startOrFlap = ()=> waitingStart ? startGame() : flap();
    document.addEventListener('keydown', e=>{ if(e.code==='Space'){ e.preventDefault(); startOrFlap(); } });
    document.getElementById('jump').addEventListener('click', startOrFlap);
    cvs.addEventListener('pointerdown', startOrFlap);

    // Dessin
    function drawSky(){
      // gradient déjà dans le style du canvas; on ajoute les nuages animés
      c.fillStyle='rgba(255,255,255,0.8)';
      clouds.forEach(cl=>{
        cl.x -= cl.s*0.6; if (cl.x < -60) cl.x = BASE_W+60;
        c.beginPath(); c.ellipse(cl.x, cl.y, 30, 18, 0, 0, Math.PI*2); c.fill();
      });
    }

    function drawShadow(){
      const sy = BASE_H - 32;
      const scale = 1 + Math.max(0, (bird.y - 200)/400);
      c.save();
      c.globalAlpha = 0.18;
      c.beginPath(); c.ellipse(bird.x, sy, 14*scale, 6*scale, 0, 0, Math.PI*2);
      c.fillStyle='#000'; c.fill(); c.restore();
    }

    function drawBird(){
      c.save(); c.translate(bird.x,bird.y);
      // angle lissé
      targetRot = Math.max(-0.6, Math.min(1.2, bird.vy/10));
      bird.rot += (targetRot - bird.rot) * 0.15;
      c.rotate(bird.rot);
      // corps
      c.beginPath(); c.arc(0,0,bird.r,0,Math.PI*2); c.fillStyle='#fff'; c.fill();
      // aile
      c.beginPath(); c.ellipse(-4,2,6,4,0,0,Math.PI*2); c.fillStyle='#f1f1f1'; c.fill();
      // bec
      c.beginPath(); c.moveTo(bird.r-2,-2); c.lineTo(bird.r+8,0); c.lineTo(bird.r-2,2); c.closePath(); c.fillStyle='#ffcc00'; c.fill();
      // oeil
      c.beginPath(); c.arc(4,-5,3,0,Math.PI*2); c.fillStyle='#000'; c.fill();
      c.restore();
    }

    function drawPipes(){
      pipes.forEach(p=>{
        const grad = c.createLinearGradient(p.x,0,p.x+p.w,0);
        grad.addColorStop(0,'#2aa32a'); grad.addColorStop(1,'#239a23');
        c.fillStyle=grad;
        c.fillRect(p.x,0,p.w,p.top);
        const bottomY=p.top+p.gap;
        c.fillRect(p.x,bottomY,p.w,BASE_H-bottomY);
        // reflets
        c.fillStyle='rgba(255,255,255,0.10)';
        c.fillRect(p.x+4,0,4,p.top);
        c.fillRect(p.x+4,bottomY,4,BASE_H-bottomY);
      });
    }

    function collide(){
      if(bird.y - bird.r <= 0 || bird.y + bird.r >= BASE_H-1) return true;
      for(const p of pipes){
        const inX = bird.x + bird.r > p.x && bird.x - bird.r < p.x + p.w;
        if(inX){
          // hitbox avec petite tolérance verticale
          const inGap = (bird.y - bird.r + 2 > p.top) && (bird.y + bird.r - 2 < p.top + p.gap);
          if(!inGap) return true;
        }
      }
      return false;
    }

    function update(dt){
      if(!running || gameOver) return;

      // Physique réaliste
      bird.vy += G;
      bird.vy = Math.min(bird.vy, 9);  // vitesse terminale
      if (bird.vy < 0) bird.vy *= 0.985; // traînée en montée
      bird.y += bird.vy;

      // Tuyaux
      const d=difficulty();
      pipes.forEach(p=> p.x -= d.speed);
      pipes = pipes.filter(p=> p.x + p.w > -10);

      // Spawn
      lastSpawn += dt;
      if(lastSpawn >= SPAWN_MS){ lastSpawn = 0; spawnPipe(); }

      // Score
      pipes.forEach(p=>{
        if(!p.passed && p.x + p.w < bird.x){ p.passed = true; score += 1; }
      });

      // Collision
      if(collide()){
        gameOver=true; running=false;
        const bestVal=Math.max(best,score); if(bestVal!==best){ best=bestVal; try{localStorage.setItem('flappy_best',best);}catch{} }
      }
    }

    function drawUI(){
      c.font='bold 28px -apple-system, system-ui, Segoe UI, Roboto, Arial';
      c.textAlign='center';
      c.fillStyle='rgba(0,0,0,0.35)'; c.fillText(score, BASE_W/2+2, 54);
      c.fillStyle='#fff'; c.fillText(score, BASE_W/2, 52);

      if (waitingStart){
        c.font='bold 32px -apple-system, system-ui, Segoe UI, Roboto, Arial';
        c.fillStyle='rgba(0,0,0,0.5)'; c.fillText('Tape pour commencer', BASE_W/2+2, BASE_H/2-8);
        c.fillStyle='#fff'; c.fillText('Tape pour commencer', BASE_W/2, BASE_H/2-10);
      } else if (gameOver){
        c.font='bold 34px -apple-system, system-ui, Segoe UI, Roboto, Arial';
        c.fillStyle='rgba(0,0,0,0.5)'; c.fillText('Perdu !', BASE_W/2+2, BASE_H/2-48);
        c.fillStyle='#fff'; c.fillText('Perdu !', BASE_W/2, BASE_H/2-50);
      }
    }

    let prev=performance.now();
    function loop(now){
      const dt=now-prev; prev=now;
      c.clearRect(0,0,cvs.width,cvs.height);
      drawSky(); drawPipes(); drawShadow(); drawBird(); update(dt); drawUI();
      requestAnimationFrame(loop);
    }
    hardReset();
    requestAnimationFrame(loop);

    // Service worker d'install pour offline (nécessite HTTPS sur GitHub Pages)
    if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('flappy_sw.js').catch(()=>{}); }); }
  })();
  </script>
</body>
</html>
